# 时间序列分析项目

## 项目结构

```
CASE-资金流入流出预测/
├── run.py           # 启动文件，仅用于启动主程序（main.py）
├── main.py          # 主程序入口，负责主菜单、调度、交互等核心逻辑
├── config.py        # 全局配置文件，集中管理路径、参数、程序列表等
├── src/             # 主功能模块目录，包含各核心业务功能的实现（如趋势图、参数搜索、预测等）
├── utils/           # 工具函数目录，存放通用工具、菜单、缓存等辅助模块
├── script/          # 次要/辅助脚本目录，存放独立运行的分析、处理脚本
├── output/          # 生成内容目录，包含 images/（图片输出）、data/（数据输出）等
├── data/            # 原始数据目录，存放所有输入数据文件
├── cache/           # 缓存目录，存放参数、图片等缓存文件
├── README.md        # 项目说明文档
└── ...              # 其它工程相关文件
```

### 结构说明
- 主流程、主功能应在 main.py 或 src/ 下实现，run.py 只做启动。
- 所有配置、路径、参数等应统一通过 config.py 管理。
- 工具函数、通用组件应放在 utils/，便于复用和维护。
- 所有输出内容应存放于 output/，保持根目录整洁。
- 临时/测试/辅助脚本建议放在 script/ 或 tests/，避免污染主目录。

---

## 快速开始

### 1. 进入项目目录
```bash
cd CASE-资金流入流出预测
```

### 2. 查看配置信息
```bash
python run.py config
```

### 3. 交互式菜单（推荐）
```bash
python run.py
```
运行后会显示菜单，使用方向键选择功能：
```
============================================================
📊 时间序列分析工具
============================================================
使用 ↑↓ 方向键选择，回车确认，q 退出
============================================================
  📈 绘制资金流入流出趋势图
▶ 🔍 ARIMA参数搜索 📋 ARIMA(2,1,3) (AIC:1234.5, 参数:6, 2.1%) ◀
  🔮 ARIMA预测
  🚀 运行所有功能
  ❓ 查看帮助
  ⚙️  查看配置
  🗑️  管理缓存
  🚪 退出程序
============================================================
```

**操作说明**：
- **↑↓ 方向键**：上下移动选择
- **回车键**：确认选择
- **q 键**：退出程序
- **自动降级**：如果方向键不工作，会自动切换到数字输入模式
- **缓存显示**：参数搜索功能右侧会显示缓存的最优参数信息
- **全方向键操作**：所有确认对话框都支持上下方向键操作

### 4. 命令行参数方式

#### 查看帮助
```bash
python run.py --help
```

#### 绘制资金流入流出趋势图
```bash
python run.py plot
```

#### ARIMA参数搜索
```bash
python run.py param-search
```

#### ARIMA预测
```bash
python run.py predict
```

#### 运行所有功能
```bash
python run.py all
```

#### 查看配置信息
```bash
python run.py config
```

## 功能说明

### 📈 绘制资金流入流出趋势图
- **功能**：绘制用户申购和赎回金额的时间趋势图
- **输出**：`output/images/purchase_redeem_trend.png`
- **缓存支持**：支持图片缓存，避免重复生成

### 🔍 ARIMA参数搜索
- **功能**：自动搜索最优的ARIMA(p,d,q)参数组合
- **算法**：基于AIC准则的网格搜索
- **防过拟合**：限制参数个数，避免模型过于复杂
- **缓存支持**：自动保存最优参数到缓存
- **输出**：控制台显示最优参数和AIC值

### 🔮 ARIMA预测（新增缓存参数支持）
- **功能**：使用ARIMA模型预测未来申购金额
- **缓存参数支持**：
  - ✅ **自动检查缓存**：优先使用缓存的ARIMA参数
  - ✅ **参数选择**：可选择使用缓存参数或生成新参数
  - ✅ **智能提示**：无缓存时提示是否生成新参数
  - ✅ **参数验证**：确保使用最佳参数进行预测
- **预测区间**：2014年9月1日~2014年12月31日
- **输出**：`output/images/arima_purchase_201409_201412_forecast.png`
- **缓存支持**：支持预测图片缓存

## 技术特点

### 🎯 智能化功能
- **参数自动搜索**：基于AIC准则自动选择最优ARIMA参数
- **缓存机制**：避免重复计算，提高效率
- **防过拟合**：限制参数个数，确保模型稳定性
- **跨平台支持**：支持Windows、macOS、Linux

### 🎨 用户体验
- **方向键导航**：直观的菜单操作体验
- **实时缓存显示**：菜单中实时显示缓存状态
- **图片自动打开**：生成图片后自动在默认应用中打开查看
- **错误处理**：完善的错误处理和用户提示

### 📊 数据管理
- **文件哈希验证**：基于文件内容确保缓存有效性
- **配置集中管理**：所有设置统一在config.py中管理
- **输出目录结构**：规范的输出文件组织

## 缓存使用流程

### 1. 首次使用
```
1. 运行ARIMA参数搜索 → 生成最优参数 → 自动保存到缓存
2. 运行ARIMA预测 → 自动使用缓存参数 → 生成预测结果
3. 查看预测图片 → 自动打开图片查看
```

### 2. 后续使用
```
1. 运行ARIMA预测 → 发现缓存参数 → 选择使用缓存或重新生成
2. 查看预测图片 → 发现缓存图片 → 选择查看或重新生成
3. 图片自动打开 → 在默认应用中查看结果
```

### 3. 缓存管理
```
1. 选择"管理缓存" → 查看所有缓存记录
2. 清除特定缓存 → 重新生成参数或图片
3. 清除所有缓存 → 完全重新开始
```

## 缓存管理功能

### 📋 缓存类型
- **ARIMA参数缓存**：存储最优的ARIMA(p,d,q)参数组合
- **图片缓存**：存储生成的趋势图和预测图路径信息

### 🗑️ 缓存操作
- **查看所有缓存**：显示所有缓存记录的详细信息
- **查看图片缓存**：专门显示图片缓存信息
- **清除当前文件缓存**：清除当前数据文件的缓存
- **清除所有缓存**：清除所有缓存记录
- **缓存设置**：查看缓存配置信息

### 📊 缓存信息
- **参数信息**：ARIMA参数、AIC值、参数个数、参数比例
- **时间信息**：缓存创建时间
- **文件信息**：数据文件路径、图片文件路径
- **状态信息**：文件是否存在、缓存是否有效

## 缓存文件结构

### JSON格式示例
```json
{
  "user_balance_table.csv_a1b2c3d4": {
    "best_params": [2, 1, 3],
    "best_aic": 1234.56,
    "total_params": 6,
    "data_length": 184,
    "param_ratio": 3.26,
    "timestamp": "2024-01-01T12:00:00",
    "data_file": "data/user_balance_table.csv",
    "images": {
      "trend": {
        "path": "output/images/purchase_redeem_trend.png",
        "type": "trend",
        "description": "用户申购和赎回金额的时间趋势图 (output/images/)",
        "timestamp": "2024-01-01T12:30:00",
        "exists": true
      },
      "prediction": {
        "path": "output/images/arima_purchase_201409_201412_forecast.png",
        "type": "prediction",
        "description": "ARIMA(2,1,3)模型预测申购金额图 (output/images/)",
        "timestamp": "2024-01-01T13:00:00",
        "exists": true
      }
    }
  }
}
```

## 使用示例

### 完整工作流程
```bash
# 1. 进入项目目录
cd CASE-资金流入流出预测

# 2. 启动交互式菜单
python run.py

# 3. 选择ARIMA参数搜索（首次使用）
# 系统会自动搜索最优参数并保存到缓存

# 4. 选择ARIMA预测
# 系统会检查缓存参数，询问是否使用

# 5. 查看生成的图片
ls output/images/
```

### 查看缓存状态
```bash
# 在菜单中选择"管理缓存"
# 查看所有缓存记录
# 查看图片缓存信息
```

## 注意事项

### ⚠️ 重要提醒
1. **数据文件**：确保`data/user_balance_table.csv`文件存在
2. **Python环境**：需要安装pandas、statsmodels、matplotlib等依赖
3. **工作目录**：必须在`CASE-资金流入流出预测`目录下运行
4. **缓存文件**：缓存文件会自动创建，无需手动管理
5. **输出目录**：程序会自动创建`output/images/`和`output/data/`目录

### 🔧 故障排除
1. **方向键不工作**：程序会自动切换到数字输入模式
2. **图片无法打开**：检查系统默认图片查看器设置
3. **缓存显示异常**：使用"管理缓存"功能刷新缓存
4. **参数搜索失败**：检查数据质量和参数范围设置

### 📈 性能优化
1. **参数范围**：合理设置p、d、q的搜索范围，避免计算时间过长
2. **缓存使用**：充分利用缓存功能，避免重复计算
3. **内存管理**：大数据集时注意内存使用情况

## 更新日志

### v2.0 (2024-01-01)
- ✅ **新增ARIMA预测缓存参数支持**
- ✅ **智能参数选择**：自动检查并使用缓存的最佳ARIMA参数
- ✅ **参数生成提示**：无缓存时提示是否生成新参数
- ✅ **三选项对话框**：使用缓存参数/生成新参数/取消预测
- ✅ **预测结果优化**：显示详细的预测统计信息
- ✅ **图片缓存增强**：预测图片自动保存到缓存

### v1.0 (2023-12-01)
- ✅ 基础ARIMA参数搜索功能
- ✅ 交互式菜单系统
- ✅ 缓存管理功能
- ✅ 图片自动打开功能
- ✅ 跨平台支持 